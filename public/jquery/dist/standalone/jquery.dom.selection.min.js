(function(g){var h=function(a){return a?a.ownerDocument.defaultView||a.ownerDocument.parentWindow:window},j=function(a){var b=g.Range.current(a).clone();a=g.Range(a).select(a);if(!b.overlaps(a))return null;if(b.compare("START_TO_START",a)<1){startPos=0;b.move("START_TO_START",a)}else{fromElementToCurrent=a.clone();fromElementToCurrent.move("END_TO_START",b);startPos=fromElementToCurrent.toString().length}endPos=b.compare("END_TO_END",a)>=0?a.toString().length:startPos+b.toString().length;return{start:startPos,
end:endPos}},n=function(a){var b=h(a);if(a.selectionStart!==undefined){if(document.activeElement&&document.activeElement!=a&&a.selectionStart==a.selectionEnd&&a.selectionStart==0)return{start:a.value.length,end:a.value.length};return{start:a.selectionStart,end:a.selectionEnd}}else if(b.getSelection)return j(a,b);else try{if(a.nodeName.toLowerCase()=="input"){var c=h(a).document.selection.createRange(),d=a.createTextRange();d.setEndPoint("EndToStart",c);var e=d.text.length;return{start:e,end:e+c.text.length}}else{var f=
j(a,b);if(!f)return f;var k=g.Range.current().clone(),l=k.clone().collapse().range,m=k.clone().collapse(false).range;l.moveStart("character",-1);m.moveStart("character",-1);if(f.startPos!=0&&l.text=="")f.startPos+=2;if(f.endPos!=0&&m.text=="")f.endPos+=2;return f}}catch(q){return{start:a.value.length,end:a.value.length}}},o=function(a,b,c){var d=h(a);if(a.setSelectionRange)if(c===undefined){a.focus();a.setSelectionRange(b,b)}else{a.select();a.selectionStart=b;a.selectionEnd=c}else if(a.createTextRange){d=
a.createTextRange();d.moveStart("character",b);c=c||b;d.moveEnd("character",c-a.value.length);d.select()}else if(d.getSelection){var e=d.document;d=d.getSelection();e=e.createRange();b=[b,c!==undefined?c:b];i([a],b);e.setStart(b[0].el,b[0].count);e.setEnd(b[1].el,b[1].count);d.removeAllRanges();d.addRange(e)}else if(d.document.body.createTextRange){e=document.body.createTextRange();e.moveToElementText(a);e.collapse();e.moveStart("character",b);e.moveEnd("character",c!==undefined?c:b);e.select()}},
p=function(a,b,c,d){if(typeof c[0]==="number"&&c[0]<b)c[0]={el:d,count:c[0]-a};if(typeof c[1]==="number"&&c[1]<=b)c[1]={el:d,count:c[1]-a}},i=function(a,b,c){var d,e;c=c||0;for(var f=0;a[f];f++){d=a[f];if(d.nodeType===3||d.nodeType===4){e=c;c+=d.nodeValue.length;p(e,c,b,d)}else if(d.nodeType!==8)c=i(d.childNodes,b,c)}return c};g.fn.selection=function(a,b){return a!==undefined?this.each(function(){o(this,a,b)}):n(this[0])};g.fn.selection.getCharElement=i})(jQuery);
